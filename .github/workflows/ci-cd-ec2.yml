name: CI/CD - Tests + SonarCloud + Deploy EC2

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  test_and_sonar:
    name: Build and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu' # Alternative distribution options are available.
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=lehhh_Lehhh_CarCore

  build_and_push:
    name: Build & Push Docker (ECR)
    runs-on: ubuntu-latest
    needs: [test_and_sonar]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      - name: Login ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & tag image
        id: meta
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY="${{ steps.ecr.outputs.registry }}"
          IMAGE_URI="$REGISTRY/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

          docker build -t "$IMAGE_URI" .
          docker tag "$IMAGE_URI" "$REGISTRY/${ECR_REPOSITORY}:latest"

      - name: Push image
        run: |
          docker push "$IMAGE_URI"
          docker push "${{ steps.ecr.outputs.registry }}/${ECR_REPOSITORY}:latest"

  deploy:
    name: Deploy EC2
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            APP_DIR='${{ secrets.EC2_APP_DIR }}'
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            cat > .env <<EOF
            APP_IMAGE=${{ needs.build_and_push.outputs.image_uri }}

            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            ADMIN_NAME=${{ secrets.ADMIN_NAME }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            ADMIN_ROLE=${{ secrets.ADMIN_ROLE }}

            VIEW_BASE_URL=${{ secrets.VIEW_BASE_URL }}

            SPRINGDOC_API_DOCS_ENABLED=${{ secrets.SPRINGDOC_API_DOCS_ENABLED }}
            SPRINGDOC_SWAGGER_UI_ENABLED=${{ secrets.SPRINGDOC_SWAGGER_UI_ENABLED }}

            JWT_ISSUER=${{ secrets.JWT_ISSUER }}
            JWT_PRIVATE_KEY_PATH=${{ secrets.JWT_PRIVATE_KEY_PATH }}
            EOF

            AWS_REGION='${{ secrets.AWS_REGION }}'
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            REGISTRY="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"

            aws ecr get-login-password --region "$AWS_REGION" \
              | docker login --username AWS --password-stdin "$REGISTRY"

            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
