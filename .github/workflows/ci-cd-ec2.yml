name: CI/CD - Tests + SonarCloud + Deploy EC2

on:
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  test_and_sonar:
    name: Tests + SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      # ✅ roda testes + gera cobertura + já manda pro Sonar no MESMO job
      # (assim o Sonar pega o jacoco sem você ter que passar path manual)
      - name: Build + Test + SonarCloud
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./mvnw -B clean verify sonar:sonar \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ secrets.SONAR_ORG }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}

      # ✅ Se for PR de fork (sem secrets), roda só testes pra não quebrar
      - name: Build + Test (PR fork sem secrets)
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository }}
        run: |
          ./mvnw -B clean verify

  build_and_push:
    name: Build & Push Docker (ECR)
    runs-on: ubuntu-latest
    needs: [test_and_sonar]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      - name: Login ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & tag image
        id: meta
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY="${{ steps.ecr.outputs.registry }}"
          IMAGE_URI="$REGISTRY/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

          docker build -t "$IMAGE_URI" .
          docker tag "$IMAGE_URI" "$REGISTRY/${ECR_REPOSITORY}:latest"

      - name: Push image
        run: |
          docker push "$IMAGE_URI"
          docker push "${{ steps.ecr.outputs.registry }}/${ECR_REPOSITORY}:latest"

  deploy:
    name: Deploy EC2
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            APP_DIR='${{ secrets.EC2_APP_DIR }}'
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            cat > .env <<EOF
            APP_IMAGE=${{ needs.build_and_push.outputs.image_uri }}

            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            ADMIN_NAME=${{ secrets.ADMIN_NAME }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            ADMIN_ROLE=${{ secrets.ADMIN_ROLE }}

            VIEW_BASE_URL=${{ secrets.VIEW_BASE_URL }}

            SPRINGDOC_API_DOCS_ENABLED=${{ secrets.SPRINGDOC_API_DOCS_ENABLED }}
            SPRINGDOC_SWAGGER_UI_ENABLED=${{ secrets.SPRINGDOC_SWAGGER_UI_ENABLED }}

            JWT_ISSUER=${{ secrets.JWT_ISSUER }}
            JWT_PRIVATE_KEY_PATH=${{ secrets.JWT_PRIVATE_KEY_PATH }}
            EOF

            AWS_REGION='${{ secrets.AWS_REGION }}'
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            REGISTRY="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"

            aws ecr get-login-password --region "$AWS_REGION" \
              | docker login --username AWS --password-stdin "$REGISTRY"

            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
